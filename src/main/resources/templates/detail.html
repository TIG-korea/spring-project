<!DOCTYPE html>
<html lang="ko">
<!-- /* THYMELEAF: <html lang="ko" xmlns:th="http://www.thymeleaf.org"> */ -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Q-Box — 질문 상세</title>
  <!-- /* THYMELEAF: th:title="${question.title} + ' — Q-Box'" */ -->
  <link rel="stylesheet" href="/css/app.css" />
</head>
<body>

  <!-- ==================== HEADER (partial include) ==================== -->
  <!-- /* THYMELEAF: <div th:replace="~{_partials/header :: header}"></div> */ -->
  <div th:replace="~{partials/header :: header}"></div>

  <!-- ==================== MAIN CONTENT ==================== -->
  <main class="main-content" id="main-content">
    <div class="container content-narrow">

      <!-- ── Back Link ── -->
      <a href="home.html" class="btn btn-secondary btn-sm" style="margin-bottom:var(--space-lg);">
        <!-- /* THYMELEAF: th:href="@{/}" */ -->
        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        목록으로
      </a>

      <!-- ==================== QUESTION DETAIL ==================== -->
      <article class="question-detail">
        <div class="question-detail-header">
          <h1 class="question-detail-title">
            <!-- /* THYMELEAF: th:text="${question.title}" */ -->
            Spring Boot에서 JPA N+1 문제 해결 방법이 궁금합니다
          </h1>
          <div class="question-detail-meta">
            <span class="badge badge-answered">답변 완료</span>
            <!-- /* THYMELEAF: 상태 배지 — answerCount > 0 이면 badge-answered, 아니면 badge-waiting */ -->
            <span>
              <!-- /* THYMELEAF: th:text="${question.author}" */ -->
              김개발
            </span>
            <span aria-hidden="true" style="color:var(--color-text-muted);">|</span>
            <time datetime="2025-01-15">
              <!-- /* THYMELEAF: th:text="${#temporals.format(question.createdAt, 'yyyy-MM-dd HH:mm')}" */ -->
              2025-01-15 14:32
            </time>
          
            <span aria-hidden="true" style="color:var(--color-text-muted);">|</span>
            <span class="view-count" title="조회수">
              <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"/><circle cx="12" cy="12" r="3"/></svg>
              <span>
                <!-- /* THYMELEAF: th:text="${question.viewCount}" */ -->
                128
              </span>
            </span>
</div>
        </div>

        <div class="question-detail-body">
          <!-- /* THYMELEAF: th:utext="${question.content}" — utext로 HTML 허용 시. 보안 주의 */ -->
          <p>
            안녕하세요. Spring Boot + JPA 환경에서 개발 중인데, 연관관계가 있는 엔티티를 조회할 때
            N+1 문제가 발생하고 있습니다.
          </p>
          <p>
            예를 들어, <code>@OneToMany</code> 관계의 엔티티를 <code>findAll()</code>로 가져오면
            각 엔티티마다 추가 쿼리가 나가는 상황입니다. <code>FetchType.LAZY</code>로 설정해도
            결국 접근 시점에 쿼리가 발생합니다.
          </p>
          <p>
            Fetch Join, <code>@EntityGraph</code>, Batch Size 설정 등 여러 방법이 있다고 하는데,
            각 방법의 장단점과 실무에서 추천하는 패턴이 궁금합니다.
          </p>
        </div>
      </article>

      <!-- ==================== ANSWERS SECTION ==================== -->
      <section class="answer-section" aria-labelledby="answers-heading">
        <h2 id="answers-heading" class="answer-section-title">
          <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <!-- /* THYMELEAF: th:text="'답변 ' + ${answers.size()} + '개'" */ -->
          답변 3개
        </h2>

        <!-- /* THYMELEAF: 답변 목록 반복 시작 — th:each="answer : ${answers}" */ -->

        <!-- 더미 답변 1 -->
        <article class="answer-item">
          <div class="answer-header">
            <div class="answer-author">
              <div class="answer-avatar" aria-hidden="true">
                <!-- /* THYMELEAF: th:text="${answer.author.charAt(0)}" */ -->
                정
              </div>
              <div>
                <div class="answer-author-name">
                  <!-- /* THYMELEAF: th:text="${answer.author}" */ -->
                  정시니어
                </div>
                <div class="answer-date">
                  <time datetime="2025-01-15T16:00">
                    <!-- /* THYMELEAF: th:text="${#temporals.format(answer.createdAt, 'yyyy-MM-dd HH:mm')}" */ -->
                    2025-01-15 16:00
                  </time>
                </div>
              </div>
            </div>
            <!-- /* THYMELEAF: 본인 답변 삭제 버튼 — th:if="${session.user != null && session.user.id == answer.authorId}" */ -->
            <!--
            <form method="post" action="/answer/delete/1"
                  onsubmit="return confirm('정말 삭제하시겠습니까?');">
              <button type="submit" class="btn btn-danger btn-sm">삭제</button>
            </form>
            -->
            <!-- /* THYMELEAF: th:action="@{/answer/delete/{id}(id=${answer.id})}" */ -->
          </div>
          <div class="answer-body">
            <p>Fetch Join이 가장 기본적인 해결법입니다. JPQL에서 <code>JOIN FETCH</code>를 사용하면
            한 번의 쿼리로 연관 엔티티까지 함께 가져올 수 있습니다.</p>
            <p>다만 컬렉션을 둘 이상 Fetch Join하면 <code>MultipleBagFetchException</code>이 발생할 수 있으니,
            이 경우에는 <code>@BatchSize</code>를 활용하는 게 좋습니다.</p>
          </div>
        </article>

        <!-- 더미 답변 2 -->
        <article class="answer-item">
          <div class="answer-header">
            <div class="answer-author">
              <div class="answer-avatar" aria-hidden="true">박</div>
              <div>
                <div class="answer-author-name">박프론트</div>
                <div class="answer-date"><time datetime="2025-01-15T18:30">2025-01-15 18:30</time></div>
              </div>
            </div>
          </div>
          <div class="answer-body">
            <p><code>@EntityGraph</code>도 추천합니다. Repository 메서드 위에 어노테이션으로 간편하게
            Fetch Join 효과를 낼 수 있어요. attributePaths로 원하는 연관 필드만 지정하면 됩니다.</p>
          </div>
        </article>

        <!-- 더미 답변 3 (본인 답변 — 삭제 버튼 표시 예시) -->
        <article class="answer-item">
          <div class="answer-header">
            <div class="answer-author">
              <div class="answer-avatar" aria-hidden="true">김</div>
              <div>
                <div class="answer-author-name">김개발 <span class="badge badge-waiting" style="font-size:0.6875rem;">내 글</span></div>
                <!-- /* THYMELEAF: '내 글' 배지는 th:if="${session.user.id == answer.authorId}" */ -->
                <div class="answer-date"><time datetime="2025-01-16T09:00">2025-01-16 09:00</time></div>
              </div>
            </div>
            <!-- 본인 답변이므로 삭제 버튼 표시 -->
            <!-- /* THYMELEAF: th:if="${session.user != null && session.user.id == answer.authorId}" */ -->
            <form method="post" action="#" onsubmit="return confirm('정말 삭제하시겠습니까?');">
              <!-- /* THYMELEAF: th:action="@{/answer/delete/{id}(id=${answer.id})}" */ -->
              <button type="submit" class="btn btn-danger btn-sm">
                <svg aria-hidden="true" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                삭제
              </button>
            </form>
          </div>
          <div class="answer-body">
            <p>두 분 답변 감사합니다! Fetch Join + BatchSize 조합으로 해결했습니다.</p>
          </div>
        </article>

        <!-- /* /THYMELEAF: 답변 목록 반복 끝 */ -->

        <!-- ==================== ANSWER WRITE FORM ==================== -->
        <!-- /* THYMELEAF: 답변 작성 폼 — 로그인 유저 전용 */ -->
        <!-- /* th:if="${session.user != null}" */ -->
        <div class="form-card mt-xl">
          <h3 class="form-title">답변 작성</h3>
          <p class="form-description">도움이 되는 답변을 남겨주세요.</p>
          <form method="post" action="#" data-validate>
            <!-- /* THYMELEAF: th:action="@{/answer/create/{questionId}(questionId=${question.id})}" */ -->
            <div class="form-group">
              <label for="answer-content" class="form-label">답변 내용 <span class="required" aria-label="필수">*</span></label>
              <textarea id="answer-content" name="content" class="form-textarea" required minlength="10"
                placeholder="답변을 입력해 주세요 (최소 10자)"></textarea>
              <p class="form-hint">마크다운은 지원하지 않습니다.</p>
            </div>
            <div class="text-right">
              <button type="submit" class="btn btn-primary">
                <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                답변 등록
              </button>
            </div>
          </form>
        </div>
        <!-- /* /THYMELEAF: 답변 작성 폼 끝 */ -->

        <!-- /* THYMELEAF: 비로그인 사용자에게 안내 */ -->
        <!-- /* th:unless="${session.user != null}" */ -->
        <!--
        <div class="form-card mt-xl text-center" style="padding:var(--space-2xl);">
          <p style="color:var(--color-text-secondary);margin-bottom:var(--space-md);">답변을 남기려면 로그인이 필요합니다.</p>
          <a href="/login" class="btn btn-primary">로그인하기</a>
        </div>
        -->
        <!-- /* /THYMELEAF: 비로그인 안내 끝 */ -->

      </section>

    </div>
  </main>

  <!-- ==================== FOOTER ==================== -->
  <!-- /* THYMELEAF: <div th:replace="~{_partials/footer :: footer}"></div> */ -->
  <footer class="site-footer" role="contentinfo">
    <div class="container">
      <p>&copy; 2025 Q-Box. 질문을 쌓아두면, 언젠가 누군가 답해주는 질문 저장소.</p>
      <p>지식 공유 커뮤니티</p>
    </div>
  </footer>

  <script src="/js/app.js"></script>
</body>
</html>
